{"componentChunkName":"component---src-templates-blog-post-js","path":"/laravel-eager-loading-is-bad/","result":{"data":{"site":{"siteMetadata":{"title":"Personal Blog"}},"markdownRemark":{"id":"63fcabe1-016c-5476-89cd-7a8e3be6bbac","excerpt":"Hello üëã  Yes, you read it right. Eager loading can be bad, really bad. However, we often resort to it when dealing with an N+1 scenario, thinking that we've‚Ä¶","html":"<h2>Hello üëã</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/536937de7d8c70b048a2e8e3866bc1cd/0f882/cover-el.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 25.316455696202528%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAA7EAAAOxAGVKw4bAAABGElEQVR42k2QW0vDQBCF8yNsspds3J3dVkkxmja9aHqJqa2tvQgiFHz0yf//B45kU8SHw5mBwzeHCb6vDb4SghWEp5iQCULILZzrQ1EKpfswLoN2mZ+VTr0ibhGyNqu4RXzZg8+EsI4Je0U4J4Sz0ki4RVU9I1+s8DBaoayPKOsD8kmNfPqC+3ENJh3CyHigFRZaWHQa4KsinBRhowg/mlBKgytmkI1WGC+OmNQnFMs9xtUBk+UO+XSNrKgQNYDIoMNbUHhR8K4IHwlhHrfOWRMi32bwuEExf8NwtkUx22FYbn27u8HCA1lkkErnGzbQ5g3BrWhBO0UgQe21SEMmNxCqCy4deOz+XKgepOqhwwwYI6TSovsP+Av3kZL1+WhxGAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"cover el\"\n        title=\"cover el\"\n        src=\"/static/536937de7d8c70b048a2e8e3866bc1cd/f058b/cover-el.png\"\n        srcset=\"/static/536937de7d8c70b048a2e8e3866bc1cd/c26ae/cover-el.png 158w,\n/static/536937de7d8c70b048a2e8e3866bc1cd/6bdcf/cover-el.png 315w,\n/static/536937de7d8c70b048a2e8e3866bc1cd/f058b/cover-el.png 630w,\n/static/536937de7d8c70b048a2e8e3866bc1cd/40601/cover-el.png 945w,\n/static/536937de7d8c70b048a2e8e3866bc1cd/78612/cover-el.png 1260w,\n/static/536937de7d8c70b048a2e8e3866bc1cd/0f882/cover-el.png 1584w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Yes, you read it right. Eager loading can be bad, really bad. However, we often resort to it when dealing with an N+1 scenario, thinking that we've resolved the issue, when in fact, we might have made it worse. How? Let's see.</p>\n<h2>How bad it gets</h2>\n<p>For this demo, we are building Laravel Forge. Like (almost) every Laravel application, we will have a <a href=\"https://laravel.com/docs/10.x/eloquent-relationships#one-to-many\">One To Many</a> relationship.</p>\n<p>We aim to log every activity for a server. A log can include the activity type, the user who initiated it, and other useful information for later analysis.</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n\n<span class=\"token keyword\">namespace</span> <span class=\"token package\">App<span class=\"token punctuation\">\\</span>Models</span><span class=\"token punctuation\">;</span>\n \n<span class=\"token keyword\">use</span> <span class=\"token package\">Illuminate<span class=\"token punctuation\">\\</span>Database<span class=\"token punctuation\">\\</span>Eloquent<span class=\"token punctuation\">\\</span>Model</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token package\">Illuminate<span class=\"token punctuation\">\\</span>Database<span class=\"token punctuation\">\\</span>Eloquent<span class=\"token punctuation\">\\</span>Relations<span class=\"token punctuation\">\\</span>HasMany</span><span class=\"token punctuation\">;</span>\n \n<span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">Server</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Model</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// ...</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">logs</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token class-name return-type\">HasMany</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token function\">hasMany</span><span class=\"token punctuation\">(</span><span class=\"token class-name static-context\">Log</span><span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></span></code></pre></div>\n<p>Now, in the application, we want to list all the servers. So, we might do something like</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token comment\">&lt;!-- It's a fancy table, use your imagination... --></span>\n\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>table</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>tr</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>th</span><span class=\"token punctuation\">></span></span>Name<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>th</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>tr</span><span class=\"token punctuation\">></span></span>\n    @foreach ($servers as $server)\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>tr</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>td</span><span class=\"token punctuation\">></span></span>{{ $server->name }}<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>td</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>tr</span><span class=\"token punctuation\">></span></span>\n    @endforeach\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>table</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<blockquote>\n<p>Moving forward, we have 10 servers, and each of them has 1000 logs.</p>\n</blockquote>\n<p>So far, so good. Now, we want to display when the last activity on a server occurred</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>table</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>tr</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>th</span><span class=\"token punctuation\">></span></span>Name<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>th</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>th</span><span class=\"token punctuation\">></span></span>Last Activity<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>th</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>tr</span><span class=\"token punctuation\">></span></span>\n    @foreach ($servers as $server)\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>tr</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>td</span><span class=\"token punctuation\">></span></span>{{ $server->name }}<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>td</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>td</span><span class=\"token punctuation\">></span></span>\n            {{ $server->logs()->latest()->first()->created_at->diffForHumans() }}\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>td</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>tr</span><span class=\"token punctuation\">></span></span>\n    @endforeach\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>table</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>Basic things, we access the <code class=\"language-text\">logs()</code> relation, ordering it to retrieve the latest record, getting the <code class=\"language-text\">created_at</code> column,  and formatting it for better readability using <code class=\"language-text\">diffForHumans()</code>. The latter yields something like  \"1 week ago\".</p>\n<p>But this is bad, we've introduced an <a href=\"https://planetscale.com/blog/what-is-n-1-query-problem-and-how-to-solve-it\">N+1</a> problem.</p>\n<p>If you don't know what a N+1 is, we are running the following queries</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\">-- 1 query to get all the servers</span>\n<span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> <span class=\"token identifier\"><span class=\"token punctuation\">`</span>servers<span class=\"token punctuation\">`</span></span>\n\n<span class=\"token comment\">-- N queries for each of servers</span>\n<span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> <span class=\"token identifier\"><span class=\"token punctuation\">`</span>logs<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">where</span> <span class=\"token identifier\"><span class=\"token punctuation\">`</span>logs<span class=\"token punctuation\">`</span></span><span class=\"token punctuation\">.</span><span class=\"token identifier\"><span class=\"token punctuation\">`</span>server_id<span class=\"token punctuation\">`</span></span> <span class=\"token operator\">=</span> <span class=\"token number\">1</span> <span class=\"token operator\">and</span> <span class=\"token identifier\"><span class=\"token punctuation\">`</span>logs<span class=\"token punctuation\">`</span></span><span class=\"token punctuation\">.</span><span class=\"token identifier\"><span class=\"token punctuation\">`</span>server_id<span class=\"token punctuation\">`</span></span> <span class=\"token operator\">is</span> <span class=\"token operator\">not</span> <span class=\"token boolean\">null</span> <span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> <span class=\"token identifier\"><span class=\"token punctuation\">`</span>created_at<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">desc</span> <span class=\"token keyword\">limit</span> <span class=\"token number\">1</span>\n<span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> <span class=\"token identifier\"><span class=\"token punctuation\">`</span>logs<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">where</span> <span class=\"token identifier\"><span class=\"token punctuation\">`</span>logs<span class=\"token punctuation\">`</span></span><span class=\"token punctuation\">.</span><span class=\"token identifier\"><span class=\"token punctuation\">`</span>server_id<span class=\"token punctuation\">`</span></span> <span class=\"token operator\">=</span> <span class=\"token number\">2</span> <span class=\"token operator\">and</span> <span class=\"token identifier\"><span class=\"token punctuation\">`</span>logs<span class=\"token punctuation\">`</span></span><span class=\"token punctuation\">.</span><span class=\"token identifier\"><span class=\"token punctuation\">`</span>server_id<span class=\"token punctuation\">`</span></span> <span class=\"token operator\">is</span> <span class=\"token operator\">not</span> <span class=\"token boolean\">null</span> <span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> <span class=\"token identifier\"><span class=\"token punctuation\">`</span>created_at<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">desc</span> <span class=\"token keyword\">limit</span> <span class=\"token number\">1</span>\n<span class=\"token comment\">-- ...</span>\n<span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> <span class=\"token identifier\"><span class=\"token punctuation\">`</span>logs<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">where</span> <span class=\"token identifier\"><span class=\"token punctuation\">`</span>logs<span class=\"token punctuation\">`</span></span><span class=\"token punctuation\">.</span><span class=\"token identifier\"><span class=\"token punctuation\">`</span>server_id<span class=\"token punctuation\">`</span></span> <span class=\"token operator\">=</span> <span class=\"token number\">10</span> <span class=\"token operator\">and</span> <span class=\"token identifier\"><span class=\"token punctuation\">`</span>logs<span class=\"token punctuation\">`</span></span><span class=\"token punctuation\">.</span><span class=\"token identifier\"><span class=\"token punctuation\">`</span>server_id<span class=\"token punctuation\">`</span></span> <span class=\"token operator\">is</span> <span class=\"token operator\">not</span> <span class=\"token boolean\">null</span> <span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> <span class=\"token identifier\"><span class=\"token punctuation\">`</span>created_at<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">desc</span> <span class=\"token keyword\">limit</span> <span class=\"token number\">1</span></code></pre></div>\n<p>To resolve this issue, we typically reach out to <a href=\"https://laravel.com/docs/10.x/eloquent-relationships#eager-loading\">Eager Loading</a> (I know you did).</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token comment\">// In your controller</span>\n<span class=\"token variable\">$servers</span> <span class=\"token operator\">=</span> <span class=\"token class-name static-context\">Server</span><span class=\"token operator\">::</span><span class=\"token function\">query</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token operator\">-></span><span class=\"token function\">with</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'logs'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token operator\">-></span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// In your blade</span>\n<span class=\"token operator\">&lt;</span>table<span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span>tr<span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span>th<span class=\"token operator\">></span>Name<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>th<span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span>th<span class=\"token operator\">></span>Last Activity<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>th<span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>tr<span class=\"token operator\">></span>\n    @<span class=\"token keyword\">foreach</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$servers</span> <span class=\"token keyword\">as</span> <span class=\"token variable\">$server</span><span class=\"token punctuation\">)</span>\n    <span class=\"token operator\">&lt;</span>tr<span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span>td<span class=\"token operator\">></span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> <span class=\"token variable\">$server</span><span class=\"token operator\">-></span><span class=\"token property\">name</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>td<span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span>td<span class=\"token operator\">></span>\n            <span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> <span class=\"token variable\">$server</span><span class=\"token operator\">-></span><span class=\"token property\">logs</span><span class=\"token operator\">-></span><span class=\"token function\">sortByDesc</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'created_at'</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">first</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token property\">created_at</span><span class=\"token operator\">-></span><span class=\"token function\">diffForHumans</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n        <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>td<span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>tr<span class=\"token operator\">></span>\n    @<span class=\"token keyword\">endforeach</span>\n<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>table<span class=\"token operator\">></span></code></pre></div>\n<p>With this update, we manage to reduce it to only 2 queries</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\">-- 1 query to get all the servers</span>\n<span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> <span class=\"token identifier\"><span class=\"token punctuation\">`</span>servers<span class=\"token punctuation\">`</span></span>\n\n<span class=\"token comment\">-- 1 query to get all the related logs</span>\n<span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> <span class=\"token identifier\"><span class=\"token punctuation\">`</span>logs<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">where</span> <span class=\"token identifier\"><span class=\"token punctuation\">`</span>logs<span class=\"token punctuation\">`</span></span><span class=\"token punctuation\">.</span><span class=\"token identifier\"><span class=\"token punctuation\">`</span>server_id<span class=\"token punctuation\">`</span></span> <span class=\"token operator\">in</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">6</span><span class=\"token punctuation\">,</span> <span class=\"token number\">7</span><span class=\"token punctuation\">,</span> <span class=\"token number\">8</span><span class=\"token punctuation\">,</span> <span class=\"token number\">9</span><span class=\"token punctuation\">,</span> <span class=\"token number\">10</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>And it looks like we addressed the problem, right?</p>\n<p>Wrong! We're only considering the number of queries. Let's examine the memory usage and the count of loaded models; these factors are equally important.</p>\n<ul>\n<li>Before eager loading\n<ul>\n<li>11 queries: 1 to retrieve all servers and 10 queries for each server.</li>\n<li>A total of 20 models loaded.</li>\n<li>Memory usage: 2MB.</li>\n<li>Execution time: 38.19 ms.</li>\n</ul>\n</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e870a1c4f2de96950e1e8c5eb07da48b/fbf08/before.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 14.556962025316455%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAoUlEQVR42m2MUQqCQABEPUlZUrYutYUQuqami2tauVTaAfqqPqMDdY4uN6HZh9DH4w3MMFqRVZDJAZe0RC4U7tkZ79sTr+sDZbTHLquwEQp8KbByEshYIZfHlhOSqEAqVLMJPAnN9rdgbgpj5qNPHIxYCJMFGFIO3eLQ6ZdBa91yW7p9jzgwph40agtQOwZZrJujybx2iDELGpsd//J/6o8PCFxk+ewsKrUAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"before\"\n        title=\"before\"\n        src=\"/static/e870a1c4f2de96950e1e8c5eb07da48b/f058b/before.png\"\n        srcset=\"/static/e870a1c4f2de96950e1e8c5eb07da48b/c26ae/before.png 158w,\n/static/e870a1c4f2de96950e1e8c5eb07da48b/6bdcf/before.png 315w,\n/static/e870a1c4f2de96950e1e8c5eb07da48b/f058b/before.png 630w,\n/static/e870a1c4f2de96950e1e8c5eb07da48b/40601/before.png 945w,\n/static/e870a1c4f2de96950e1e8c5eb07da48b/fbf08/before.png 962w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<ul>\n<li>After eager loading\n<ul>\n<li>2 queries: 1 to get all servers and 1 to get all logs.</li>\n<li>A total of 10010 models loaded ü§Ø.</li>\n<li>Memory usage: 13MB (6.5x increase).</li>\n<li>Execution time: 66.5 ms (1.7x increase).</li>\n<li>Slower computational time due to loading all the models üê¢.</li>\n</ul>\n</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/7bb0cce47e671ba3300db1578ca197ed/fbf08/after.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 14.556962025316455%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsTAAALEwEAmpwYAAAApUlEQVR42nXLuw7BUACA4T6JuCRKi2pqaNGLtqftQZzUJTaD3WIWs0eye7Bf0KGL4Zv+/NpGHshEybnYI2PFZXnkdb3xvD84hSvU8ohMS3xXMHdTslghxZZ1vkOKErHYkCeKIlEEswzN8VdYXk5n5NPou+h2xGCS0DanNGtalabhVaY/Vf+8neEMzXQSTCemb0foVkBvHNK1gi/dCmuCSviXYUe8AXdYZYNQnHC7AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"after\"\n        title=\"after\"\n        src=\"/static/7bb0cce47e671ba3300db1578ca197ed/f058b/after.png\"\n        srcset=\"/static/7bb0cce47e671ba3300db1578ca197ed/c26ae/after.png 158w,\n/static/7bb0cce47e671ba3300db1578ca197ed/6bdcf/after.png 315w,\n/static/7bb0cce47e671ba3300db1578ca197ed/f058b/after.png 630w,\n/static/7bb0cce47e671ba3300db1578ca197ed/40601/after.png 945w,\n/static/7bb0cce47e671ba3300db1578ca197ed/fbf08/after.png 962w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<blockquote>\n<p>The tool in the screenshot is <a href=\"https://github.com/barryvdh/laravel-debugbar\">Debugbar</a>.</p>\n</blockquote>\n<p>Looks like we didn't fix anything; in fact, we made it worse.. And keep in mind, this is a very simplified example. In a real world scenario, you can easily end up with hundreds or thousands of records, leading to the loading of millions of models.. The title makes sense now?</p>\n<h2>How do we <em>truly</em> solve this?</h2>\n<p>In our case, eager loading is a NO NO. Instead, we can use sub-queries and leverage the database to perform tasks it is built and optimized for.</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token variable\">$servers</span> <span class=\"token operator\">=</span> <span class=\"token class-name static-context\">Server</span><span class=\"token operator\">::</span><span class=\"token function\">query</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token operator\">-></span><span class=\"token function\">addSelect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n        <span class=\"token string single-quoted-string\">'last_activity'</span> <span class=\"token operator\">=></span> <span class=\"token class-name static-context\">Log</span><span class=\"token operator\">::</span><span class=\"token function\">select</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'created_at'</span><span class=\"token punctuation\">)</span>\n            <span class=\"token operator\">-></span><span class=\"token function\">whereColumn</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'server_id'</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'servers.id'</span><span class=\"token punctuation\">)</span>\n            <span class=\"token operator\">-></span><span class=\"token function\">latest</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token operator\">-></span><span class=\"token function\">take</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    <span class=\"token operator\">-></span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>This will result in a single query</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">select</span> <span class=\"token identifier\"><span class=\"token punctuation\">`</span>servers<span class=\"token punctuation\">`</span></span><span class=\"token punctuation\">.</span><span class=\"token operator\">*</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>\n        <span class=\"token keyword\">select</span> <span class=\"token identifier\"><span class=\"token punctuation\">`</span>created_at<span class=\"token punctuation\">`</span></span>\n        <span class=\"token keyword\">from</span> <span class=\"token identifier\"><span class=\"token punctuation\">`</span>logs<span class=\"token punctuation\">`</span></span>\n        <span class=\"token keyword\">where</span>\n            <span class=\"token identifier\"><span class=\"token punctuation\">`</span>server_id<span class=\"token punctuation\">`</span></span> <span class=\"token operator\">=</span> <span class=\"token identifier\"><span class=\"token punctuation\">`</span>servers<span class=\"token punctuation\">`</span></span><span class=\"token punctuation\">.</span><span class=\"token identifier\"><span class=\"token punctuation\">`</span>id<span class=\"token punctuation\">`</span></span>\n        <span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> <span class=\"token identifier\"><span class=\"token punctuation\">`</span>created_at<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">desc</span>\n        <span class=\"token keyword\">limit</span> <span class=\"token number\">1</span>\n    <span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> <span class=\"token identifier\"><span class=\"token punctuation\">`</span>last_activity<span class=\"token punctuation\">`</span></span>\n<span class=\"token keyword\">from</span> <span class=\"token identifier\"><span class=\"token punctuation\">`</span>servers<span class=\"token punctuation\">`</span></span></code></pre></div>\n<p>Since the column we need from the relationship is now computed in a subquery, we have the best of both worlds: only 10 models loaded and minimal memory usage.</p>\n<p>You might be thinking that with this approach comes a drawback: the <code class=\"language-text\">last_activity</code> column is now a regular string. So, if you want to use the <code class=\"language-text\">diffForHumans()</code> method, you'll encounter the <code class=\"language-text\">Call to a member function diffForHumans() on string</code> error. But no worries, you haven't lost the casting; it's as simple as adding a single line.</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token variable\">$servers</span> <span class=\"token operator\">=</span> <span class=\"token class-name static-context\">Server</span><span class=\"token operator\">::</span><span class=\"token function\">query</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token operator\">-></span><span class=\"token function\">addSelect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n        <span class=\"token string single-quoted-string\">'last_activity'</span> <span class=\"token operator\">=></span> <span class=\"token class-name static-context\">Log</span><span class=\"token operator\">::</span><span class=\"token function\">select</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'created_at'</span><span class=\"token punctuation\">)</span>\n            <span class=\"token operator\">-></span><span class=\"token function\">whereColumn</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'server_id'</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'servers.id'</span><span class=\"token punctuation\">)</span>\n            <span class=\"token operator\">-></span><span class=\"token function\">latest</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token operator\">-></span><span class=\"token function\">take</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    <span class=\"token operator\">-></span><span class=\"token function\">withCasts</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'last_activity'</span> <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'datetime'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// casts here</span>\n    <span class=\"token operator\">-></span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>By chaining the <code class=\"language-text\">withCasts()</code> method, you can now treat the <code class=\"language-text\">last_activity</code> as if it were a date.</p>\n<p>That's it! This is the best it can be.</p>\n<h2>Conclusion</h2>\n<p>I have seen some developers, by design, choose to force eager loading for all the models. You can't just use it for everything, as much as it seems like you've solved the issue, you might have actually created a worse one. Not everything is a nail; the hammer might not work üî®</p>","frontmatter":{"title":"Laravel - Eager loading can be bad!","date":"January 28, 2024","description":"Whenever we encounter an N+1, we usually resort to Eager Loading. As much as it seems like the appropriate solution, it can be the opposite.."}},"previous":{"fields":{"slug":"/laravel-core-facades/"},"frontmatter":{"title":"Laravel Under The Hood - Facades"}},"next":null},"pageContext":{"id":"63fcabe1-016c-5476-89cd-7a8e3be6bbac","previousPostId":"dd83214f-98ff-5a9b-a1f6-07a02ac42647","nextPostId":null}},"staticQueryHashes":["2841359383","494442451"],"slicesMap":{}}
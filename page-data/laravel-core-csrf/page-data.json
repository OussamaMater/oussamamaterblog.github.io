{"componentChunkName":"component---src-templates-blog-post-js","path":"/laravel-core-csrf/","result":{"data":{"site":{"siteMetadata":{"title":"Personal Blog"}},"markdownRemark":{"id":"37a1019d-eebc-5e04-841c-ae70e4179b1d","excerpt":"Hello  ðŸ‘‹  I know you've probably encountered this at least once. You copy-pasted the exception, did a little Googling, and found out that adding a directiveâ€¦","html":"<h2>Hello <code class=\"language-text\">TokenMismatchException</code> ðŸ‘‹</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/69d616c4fd0ab1abde9dbed9d89fdb7e/7527b/csrf.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 21.51898734177215%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsTAAALEwEAmpwYAAABCklEQVR42lXPz0rCcADA8Z17i6BrROfOQSFI0QvYpUuH3qRX8JA30UwP/rmEdXCpKKw5t+XSn7P8M21UqGu4fYNAqg98H+Arqa0mD3KNbK7EWhiG/ArxXIdgteKviqhRHSnIdp2yqKA5JiWrjJRMJYjFLtjc2uMqkWLwMkDTdRaezxJwbIF9vsui10Yodwj1lvd8HjsSwVUVrPmQqt3AX/l03T5SvpgjGj1le2efo5MzrG4XVWvz9rnADcHKxnk93mCSvGTcNxkJhVkmjX1wSKEQR/sQmE6HeyFjTC2k5fKLzE2R9HWBRlMlCIKf1nx3wrxv4k2H/5bbI4P6WOVp9kzLMdCnHRrDR74BnMwUt+wjjUEAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"csrf\"\n        title=\"csrf\"\n        src=\"/static/69d616c4fd0ab1abde9dbed9d89fdb7e/f058b/csrf.png\"\n        srcset=\"/static/69d616c4fd0ab1abde9dbed9d89fdb7e/c26ae/csrf.png 158w,\n/static/69d616c4fd0ab1abde9dbed9d89fdb7e/6bdcf/csrf.png 315w,\n/static/69d616c4fd0ab1abde9dbed9d89fdb7e/f058b/csrf.png 630w,\n/static/69d616c4fd0ab1abde9dbed9d89fdb7e/7527b/csrf.png 754w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>I know you've probably encountered this at least once. You copy-pasted the exception, did a little Googling, and found out that adding a directive like <code class=\"language-text\">@csrf</code> or including the header <code class=\"language-text\">X-CSRF-TOKEN</code> in your request is the fix. We've all been down that road. But have you ever wondered why Laravel throws this exception in the first place? Do you truly need to send a token with every single request? Well, yes, YEEES you have to. Otherwise, they'll start making jokes about PHP not being secure ðŸ˜’. To get this, let's step back and talk about an old <em>yet still existing</em> vulnerability called <a href=\"https://owasp.org/www-community/attacks/csrf\">CSRF</a>.</p>\n<h2>Soo, Cross-Site Request Forgery?</h2>\n<blockquote>\n<p>Look at me, a scary name ðŸ‘», but I'm pretty straightforward.</p>\n</blockquote>\n<p>Imagine you're a high school student with a major crush on a girl. The catch? You're shy, wishing she would send a friend request your way instead. Wouldn't that be cool? Well, let's make it work ðŸ˜ˆ</p>\n<p>The mission: Get her to act as if she is you without her realizing it.</p>\n<p>So, you'd create a simple web page featuring cute dog pics (or whatever she's into). When she loads this page, a request triggers in the background, this request is crafted by you. For instance, it could be a POST request to an endpoint that adds whatever is given in the payload as a friend. In our case, you'd request to add yourself as her friend (I hate to say it, but you have to use JavaScript). Sneakily, you'll share this link, maybe through her friends or, well, that part's up to you ðŸ˜›. She receives the link, clicks it, the code executes, and the request is sent to the server using <em>her cookies</em> and <em>her active session</em>. This happens because <strong>cookies are automatically sent with every single request</strong>, and this is what enables the vulnerability. If she's logged in (most likely), she unknowingly sends you that friend request. And that, my friend, is CSRF in action.</p>\n<blockquote>\n<p>Note that there are certain <a href=\"https://www.invicti.com/learn/cookie-security-flags/\">cookie security flags</a> we set to prevent this behavior, but we won't be discussing about them for now.</p>\n</blockquote>\n<p>In summary, you exploit the victim's (in this case, the girl) ongoing session. You trick them into loading a web page or clicking a button that sends a request, crafted by you, to the server using their session. This allows you to execute <strong>any</strong> action you want on their account, such as deletion, liking your own posts, or potentially even worse scenarios..</p>\n<h2>And how does Laravel solve this?</h2>\n<p>Let's first discuss the solution concept and then dive into Laravel's implementation. In our scenario, everything fell into place because, well, the guy had everything needed to craft the payload. This could have been prevented if there were a randomly generated token tied to the girl's session that couldn't be guessed or cracked. Why? Because this token is encrypted using a key stored <strong>only on the server</strong>. That's the essence of the solution: any request doing a significant task, like adding a friend, should carry a token, to ensure the genuine user, of their own volition, initiated the action. For instance, if someone attempts a request while you're admiring those cute dog pictures, the server won't authorize it because there's no way the hacker has guessed and provided the token in their crafted request.</p>\n<p>To explore how Laravel implements this, let's navigate to <code class=\"language-text\">app/Http/Kernel.php</code></p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token string single-quoted-string\">'web'</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">[</span>\n    <span class=\"token class-name class-name-fully-qualified static-context\"><span class=\"token punctuation\">\\</span>App<span class=\"token punctuation\">\\</span>Http<span class=\"token punctuation\">\\</span>Middleware<span class=\"token punctuation\">\\</span>EncryptCookies</span><span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span>\n    <span class=\"token class-name class-name-fully-qualified static-context\"><span class=\"token punctuation\">\\</span>Illuminate<span class=\"token punctuation\">\\</span>Cookie<span class=\"token punctuation\">\\</span>Middleware<span class=\"token punctuation\">\\</span>AddQueuedCookiesToResponse</span><span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span>\n    <span class=\"token class-name class-name-fully-qualified static-context\"><span class=\"token punctuation\">\\</span>Illuminate<span class=\"token punctuation\">\\</span>Session<span class=\"token punctuation\">\\</span>Middleware<span class=\"token punctuation\">\\</span>StartSession</span><span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span>\n    <span class=\"token class-name class-name-fully-qualified static-context\"><span class=\"token punctuation\">\\</span>Illuminate<span class=\"token punctuation\">\\</span>View<span class=\"token punctuation\">\\</span>Middleware<span class=\"token punctuation\">\\</span>ShareErrorsFromSession</span><span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span>\n    <span class=\"token class-name class-name-fully-qualified static-context\"><span class=\"token punctuation\">\\</span>App<span class=\"token punctuation\">\\</span>Http<span class=\"token punctuation\">\\</span>Middleware<span class=\"token punctuation\">\\</span>VerifyCsrfToken</span><span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// &lt;- this guy</span>\n    <span class=\"token class-name class-name-fully-qualified static-context\"><span class=\"token punctuation\">\\</span>Illuminate<span class=\"token punctuation\">\\</span>Routing<span class=\"token punctuation\">\\</span>Middleware<span class=\"token punctuation\">\\</span>SubstituteBindings</span><span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></code></pre></div>\n<p>These represent the <a href=\"https://laravel.com/docs/10.x/middleware\">middlewares</a> applied to all web routes. Our focus lies on <code class=\"language-text\">VerifyCsrfToken</code>. Let's take a closer look at it</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n\n<span class=\"token keyword\">namespace</span> <span class=\"token package\">App<span class=\"token punctuation\">\\</span>Http<span class=\"token punctuation\">\\</span>Middleware</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">use</span> <span class=\"token package\">Illuminate<span class=\"token punctuation\">\\</span>Foundation<span class=\"token punctuation\">\\</span>Http<span class=\"token punctuation\">\\</span>Middleware<span class=\"token punctuation\">\\</span>VerifyCsrfToken</span> <span class=\"token keyword\">as</span> Middleware<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">VerifyCsrfToken</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Middleware</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">/**\n     * The URIs that should be excluded from CSRF verification.\n     *\n     * @var array&lt;int, string>\n     */</span>\n    <span class=\"token keyword\">protected</span> <span class=\"token variable\">$except</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token comment\">//</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></span></code></pre></div>\n<p>Nothing special, so our next direction is the parent class <code class=\"language-text\">VerifyCsrfToken</code></p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n\n<span class=\"token keyword\">namespace</span> <span class=\"token package\">Illuminate<span class=\"token punctuation\">\\</span>Foundation<span class=\"token punctuation\">\\</span>Http<span class=\"token punctuation\">\\</span>Middleware</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">use</span> <span class=\"token package\">Closure</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token package\">Illuminate<span class=\"token punctuation\">\\</span>Session<span class=\"token punctuation\">\\</span>TokenMismatchException</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">VerifyCsrfToken</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">/**\n     * Handle an incoming request.\n     *\n     * @param  \\Illuminate\\Http\\Request  $request\n     * @param  \\Closure  $next\n     * @return mixed\n     *\n     * @throws \\Illuminate\\Session\\TokenMismatchException\n     */</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">handle</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$request</span><span class=\"token punctuation\">,</span> <span class=\"token class-name type-declaration\">Closure</span> <span class=\"token variable\">$next</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>\n            <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token function\">isReading</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$request</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span>\n            <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token function\">runningUnitTests</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span>\n            <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token function\">inExceptArray</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$request</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span>\n            <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token function\">tokensMatch</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$request</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> <span class=\"token function\">tap</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$next</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$request</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$response</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">use</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$request</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token function\">shouldAddXsrfTokenCookie</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token function\">addCookieToResponse</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$request</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$response</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">TokenMismatchException</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'CSRF token mismatch.'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// more code</span>\n<span class=\"token punctuation\">}</span>\n</span></code></pre></div>\n<p>Like every middleware, we are interested in the <code class=\"language-text\">handle()</code> method. You can see several checks are performed. If all these checks fail, Laravel throws the <code class=\"language-text\">TokenMismatchException</code> exception. Now that you know where the exception is thrown, let's discuss the checks:</p>\n<ul>\n<li><code class=\"language-text\">isReading()</code>: This checks if the request uses an HTTP read verb (<code class=\"language-text\">HEAD</code>, <code class=\"language-text\">GET</code> and <code class=\"language-text\">OPTIONS</code>), that is why you have never encountered this issue when making one these of requests;</li>\n<li><code class=\"language-text\">runningUnitTests()</code>: As you might have guessed, this checks if the application is running in the console and the request is made from tests, there is no absolute need to verify the token (assuming you write tests ðŸ‘€);</li>\n<li><code class=\"language-text\">inExceptArray()</code>: Remember the <code class=\"language-text\">$except</code> array in the <code class=\"language-text\">VerifyCsrfToken</code> middleware we previously explored? This checks if the current route is defined in the array and should be excluded from the token verification (don't mess with it unless you know what you are doing); finally</li>\n<li><code class=\"language-text\">tokensMatch()</code>: This is where the magic happens. It checks if the token passed along with the request matches the one stored in the session. This step is usually the cause of the exception, so let's take a closer look.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n\n<span class=\"token keyword\">namespace</span> <span class=\"token package\">Illuminate<span class=\"token punctuation\">\\</span>Foundation<span class=\"token punctuation\">\\</span>Http<span class=\"token punctuation\">\\</span>Middleware</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">use</span> <span class=\"token package\">Illuminate<span class=\"token punctuation\">\\</span>Http<span class=\"token punctuation\">\\</span>Request</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">VerifyCsrfToken</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">protected</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">tokensMatch</span><span class=\"token punctuation\">(</span><span class=\"token class-name type-declaration\">Request</span> <span class=\"token variable\">$request</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword return-type\">bool</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token variable\">$token</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token function\">getTokenFromRequest</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$request</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">return</span> <span class=\"token function\">is_string</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$request</span><span class=\"token operator\">-></span><span class=\"token function\">session</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">token</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span>\n               <span class=\"token function\">is_string</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$token</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span>\n               <span class=\"token function\">hash_equals</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$request</span><span class=\"token operator\">-></span><span class=\"token function\">session</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">token</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$token</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// more code</span>\n<span class=\"token punctuation\">}</span></span></code></pre></div>\n<p>So, Laravel attempts to retrieve a token from the request. Let's explore this further</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n\n<span class=\"token keyword\">namespace</span> <span class=\"token package\">Illuminate<span class=\"token punctuation\">\\</span>Foundation<span class=\"token punctuation\">\\</span>Http<span class=\"token punctuation\">\\</span>Middleware</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">use</span> <span class=\"token package\">Illuminate<span class=\"token punctuation\">\\</span>Http<span class=\"token punctuation\">\\</span>Request</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token package\">Illuminate<span class=\"token punctuation\">\\</span>Cookie<span class=\"token punctuation\">\\</span>CookieValuePrefix</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token package\">Illuminate<span class=\"token punctuation\">\\</span>Contracts<span class=\"token punctuation\">\\</span>Encryption<span class=\"token punctuation\">\\</span>Encrypter</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token package\">Illuminate<span class=\"token punctuation\">\\</span>Contracts<span class=\"token punctuation\">\\</span>Encryption<span class=\"token punctuation\">\\</span>DecryptException</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">VerifyCsrfToken</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">protected</span> <span class=\"token class-name type-declaration\">Encrypter</span> <span class=\"token variable\">$encrypter</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">protected</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">getTokenFromRequest</span><span class=\"token punctuation\">(</span><span class=\"token class-name type-declaration\">Request</span> <span class=\"token variable\">$request</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword return-type\">string</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token variable\">$token</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$request</span><span class=\"token operator\">-></span><span class=\"token function\">input</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'_token'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span><span class=\"token punctuation\">:</span> <span class=\"token variable\">$request</span><span class=\"token operator\">-></span><span class=\"token function\">header</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'X-CSRF-TOKEN'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        \n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span> <span class=\"token variable\">$token</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token variable\">$header</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$request</span><span class=\"token operator\">-></span><span class=\"token function\">header</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'X-XSRF-TOKEN'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token variable\">$token</span> <span class=\"token operator\">=</span> <span class=\"token class-name static-context\">CookieValuePrefix</span><span class=\"token operator\">::</span><span class=\"token function\">remove</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">encrypter</span><span class=\"token operator\">-></span><span class=\"token function\">decrypt</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$header</span><span class=\"token punctuation\">,</span> <span class=\"token keyword static-context\">static</span><span class=\"token operator\">::</span><span class=\"token function\">serialized</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">DecryptException</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token variable\">$token</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">''</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">return</span> <span class=\"token variable\">$token</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// more code</span>\n<span class=\"token punctuation\">}</span></span></code></pre></div>\n<p>Laravel tries to get the token from a field named <code class=\"language-text\">_token</code> for any write request, typically associated with a regular form submission. If that's not found, it looks for the token in the header <code class=\"language-text\">X-CSRF-TOKEN</code>, used for AJAX requests.</p>\n<p>Should the token remain unset, Laravel checks for it in <code class=\"language-text\">X-XSRF-TOKEN</code>. Now, you might wonder about this header. It's primarily for developer convenience. Laravel sends back a cookie named <code class=\"language-text\">XSRF-TOKEN</code> with every response. Some libraries, when making requests, set the value of this cookie to the <code class=\"language-text\">X-XSRF-TOKEN</code> header on every request they make, automatically. Essentially, Laravel is like, let's also check if this request is made by Axios, or other JS libraries. Eventually, the <code class=\"language-text\">$token</code> is returned.</p>\n<p>Back to the <code class=\"language-text\">tokensMatch()</code> method</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n\n<span class=\"token keyword\">namespace</span> <span class=\"token package\">Illuminate<span class=\"token punctuation\">\\</span>Foundation<span class=\"token punctuation\">\\</span>Http<span class=\"token punctuation\">\\</span>Middleware</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">use</span> <span class=\"token package\">Illuminate<span class=\"token punctuation\">\\</span>Http<span class=\"token punctuation\">\\</span>Request</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">VerifyCsrfToken</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">protected</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">tokensMatch</span><span class=\"token punctuation\">(</span><span class=\"token class-name type-declaration\">Request</span> <span class=\"token variable\">$request</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword return-type\">bool</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token variable\">$token</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token function\">getTokenFromRequest</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$request</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">return</span> <span class=\"token function\">is_string</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$request</span><span class=\"token operator\">-></span><span class=\"token function\">session</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">token</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span>\n               <span class=\"token function\">is_string</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$token</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span>\n               <span class=\"token function\">hash_equals</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$request</span><span class=\"token operator\">-></span><span class=\"token function\">session</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">token</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$token</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// more code</span>\n<span class=\"token punctuation\">}</span></span></code></pre></div>\n<p>The <code class=\"language-text\">$token</code> value retrieved from the request is compared to whatever stored in the Laravel session. Let's navigate to <code class=\"language-text\">storage/framework/sessions</code> (assuming you haven't touched the default session config), there you will find user sessions. Inspect any of these files</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\">a<span class=\"token operator\">:</span><span class=\"token number\">3</span><span class=\"token operator\">:</span><span class=\"token punctuation\">{</span>s<span class=\"token operator\">:</span><span class=\"token number\">6</span><span class=\"token operator\">:</span><span class=\"token string\">\"_token\"</span>;s<span class=\"token operator\">:</span><span class=\"token number\">40</span><span class=\"token operator\">:</span><span class=\"token string\">\"bi2fA9ienYF09b5Ny3ovCvUR5NpStGkPAMDWOFg7\"</span>;s<span class=\"token operator\">:</span><span class=\"token number\">9</span><span class=\"token operator\">:</span><span class=\"token string\">\"_previous\"</span>;a<span class=\"token operator\">:</span><span class=\"token number\">1</span><span class=\"token operator\">:</span><span class=\"token punctuation\">{</span>s<span class=\"token operator\">:</span><span class=\"token number\">3</span><span class=\"token operator\">:</span><span class=\"token string\">\"url\"</span>;s<span class=\"token operator\">:</span><span class=\"token number\">21</span><span class=\"token operator\">:</span><span class=\"token string\">\"http://localhost\"</span>;<span class=\"token punctuation\">}</span>s<span class=\"token operator\">:</span><span class=\"token number\">6</span><span class=\"token operator\">:</span><span class=\"token string\">\"_flash\"</span>;a<span class=\"token operator\">:</span><span class=\"token number\">2</span><span class=\"token operator\">:</span><span class=\"token punctuation\">{</span>s<span class=\"token operator\">:</span><span class=\"token number\">3</span><span class=\"token operator\">:</span><span class=\"token string\">\"old\"</span>;a<span class=\"token operator\">:</span><span class=\"token number\">0</span><span class=\"token operator\">:</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>s<span class=\"token operator\">:</span><span class=\"token number\">3</span><span class=\"token operator\">:</span><span class=\"token string\">\"new\"</span>;a<span class=\"token operator\">:</span><span class=\"token number\">0</span><span class=\"token operator\">:</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span></code></pre></div>\n<p>A serialised PHP object that encapsulates the session, and notice the <code class=\"language-text\">_token</code> field.</p>\n<p>Hence, whatever stored in the user's session under the key <code class=\"language-text\">_token</code> must match the token provided in any write request. If not Laravel will throw the <code class=\"language-text\">TokenMismatchException</code> exception.</p>\n<p>Now you might be wondering, \"when did I even send this token?\" Well, when you encountered this exception, the solution involved adding the <code class=\"language-text\">@csrf</code> directive right? This directive embeds a hidden field in your HTML form with the correct token value.</p>\n<p>Shall we explore this further? go to <code class=\"language-text\">Illuminate\\View\\Compilers\\Concerns\\CompilesHelpers</code></p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n\n<span class=\"token keyword\">namespace</span> <span class=\"token package\">Illuminate<span class=\"token punctuation\">\\</span>View<span class=\"token punctuation\">\\</span>Compilers<span class=\"token punctuation\">\\</span>Concerns</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">trait</span> <span class=\"token class-name-definition class-name\">CompilesHelpers</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">protected</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">compileCsrf</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword return-type\">string</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token string single-quoted-string\">'&lt;?php echo csrf_field(); ?>'</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// more code here</span>\n<span class=\"token punctuation\">}</span></span></code></pre></div>\n<p>The result of this method will replace the <code class=\"language-text\">@csrf</code> directive. Taking a look into the <code class=\"language-text\">csrf_field()</code> function found in the <code class=\"language-text\">helpers.php</code> file, we'll come across the following code snippet</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token keyword\">function</span> <span class=\"token function-definition function\">csrf_field</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HtmlString</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'&lt;input type=\"hidden\" name=\"_token\" value=\"'</span><span class=\"token operator\">.</span><span class=\"token function\">csrf_token</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">'\" autocomplete=\"off\">'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Looks familiar? That is the hidden field named <code class=\"language-text\">_token</code>, I was telling you about. This is why the <code class=\"language-text\">getTokenFromRequest()</code> method looks for <code class=\"language-text\">_token</code> key. Now, let's solidify everything we've discussed throughout this article by inspecting the <code class=\"language-text\">csrf_token()</code> function</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token keyword\">function</span> <span class=\"token function-definition function\">csrf_token</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token variable\">$session</span> <span class=\"token operator\">=</span> <span class=\"token function\">app</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'session'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$session</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token variable\">$session</span><span class=\"token operator\">-></span><span class=\"token function\">token</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RuntimeException</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'Application session store not set.'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// more code</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Notice how the function returns whatever is within <code class=\"language-text\">$session->token()</code> (though we won't dive into this code otherwise we will have to discuss Laravel's manager pattern ðŸ˜›). The input field, named <code class=\"language-text\">_token</code>, sent along with the request, has the exact value set in the session. If these values match in the <code class=\"language-text\">tokensMatch()</code> method (and now you know why), which they will if the request is genuine, Laravel will be happy, otherwise, he will throw the exception.</p>\n<p>That's it! you gathered all the pieces!</p>\n<h2>Conclusion</h2>\n<p>Hey, you made it this far ðŸŽ‰ Look at you, now well-versed in Laravel internals and also more aware of web vulnerabilities! The next time Laravel throws an exception, don't get mad, it's for your own good!</p>\n<p>I'm considering writing more about Laravel internals, do you think it is a good idea? I would love to hear your thoughts. Feel free to reach out to me on any of the platforms listed below!</p>","frontmatter":{"title":"Laravel Under The Hood - CSRF","date":"December 12, 2023","description":"Not once, not twice have we faced the infamous 'Token Mismatch' exception in Laravel. But hey, the poor guy is just looking out for you, trying to shield you from the evil ðŸ˜ˆ, let's have a look.."}},"previous":{"fields":{"slug":"/php-attributes/"},"frontmatter":{"title":"PHP attributes in Laravel"}},"next":{"fields":{"slug":"/laravel-core-facades/"},"frontmatter":{"title":"Laravel Under The Hood - Facades"}}},"pageContext":{"id":"37a1019d-eebc-5e04-841c-ae70e4179b1d","previousPostId":"703fa372-1f8f-5751-b8ee-a3039da0092a","nextPostId":"dd83214f-98ff-5a9b-a1f6-07a02ac42647"}},"staticQueryHashes":["2841359383","494442451"],"slicesMap":{}}
{"componentChunkName":"component---src-templates-blog-post-js","path":"/facades-write-testable-code/","result":{"data":{"site":{"siteMetadata":{"title":"Personal Blog"}},"markdownRemark":{"id":"956642b6-a0f2-5634-9742-a6d32b383180","excerpt":"Hello 👋  For one reason or another, Laravel Facades don't get much love. I often read about how they are not a true facade implementation, and let me tell you…","html":"<h2 id=\"hello-\" style=\"position:relative;\"><a href=\"#hello-\" aria-label=\"hello  permalink\" class=\"anchor before\"><svg fill=\"#A855F7\" height=\"25px\" width=\"25px\" version=\"1.1\" id=\"Capa_1\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" \n              viewBox=\"0 0 490 490\" xml:space=\"preserve\">\n           <path d=\"M64.333,490h58.401l33.878-137.69h122.259L245.39,490h58.401l33.878-137.69h119.92v-48.162h-108.24l29.2-117.324h79.04\n             v-48.162H390.23L424.108,0H365.31l-33.878,138.661H208.79L242.668,0h-58.415l-33.864,138.661H32.411v48.162h106.298l-28.818,117.324\n             h-77.48v48.162h65.8L64.333,490z M197.11,186.824h122.642l-29.2,117.324H168.292L197.11,186.824z\"/>\n           </svg></a>Hello 👋</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/15441dce00f34d83577a0416bda8202d/0f882/cover-facades.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 25.316455696202528%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAA7EAAAOxAGVKw4bAAABWUlEQVR42i2QzUrcUABG8waOzk+aGZObe2+SuZlkMolJJnFEbaHtI7RQ+gIuBH+Q0q0gdCOtuKvgzpWCW5Euuu6qa8FnOTKli29xOJvDZzkjjfQUTRxQmoBZqBGOy0pnyGrfY6Xr0em6dHrLLdml3xsRC8FUS6bKp80MbVuxOV9g9WxBKCT+UJEGY97Na942JTtVwSLPeN+W7FYF7SxjkU+p04TMxGzlM95UJblJkI6gjiQbcYQ1cBRFpEldm/P9DzzdfePPzxMefhxxcfiZv9df+X15zOPlF55uz7g53eP7wSd+XRzxfH/O1fFHcjGkiRVFKLEik5GPDWrkMglCEq1RQqKEwluXNO02O5u7bG+9pqlqpCfxRcBYahIdoD0f47qU44B8YrCKjZYsLRi88lkbSPqOZlndHfj0bEk0qTBpjUnnuDL996X936/2BWu2ZH0kycKAaZrwAsSeobGEFpLmAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"cover facades\"\n        title=\"cover facades\"\n        src=\"/static/15441dce00f34d83577a0416bda8202d/f058b/cover-facades.png\"\n        srcset=\"/static/15441dce00f34d83577a0416bda8202d/c26ae/cover-facades.png 158w,\n/static/15441dce00f34d83577a0416bda8202d/6bdcf/cover-facades.png 315w,\n/static/15441dce00f34d83577a0416bda8202d/f058b/cover-facades.png 630w,\n/static/15441dce00f34d83577a0416bda8202d/40601/cover-facades.png 945w,\n/static/15441dce00f34d83577a0416bda8202d/78612/cover-facades.png 1260w,\n/static/15441dce00f34d83577a0416bda8202d/0f882/cover-facades.png 1584w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>For one reason or another, <a href=\"https://blog.oussama-mater.tech/laravel-core-facades/\">Laravel Facades</a> don't get much love. I often read about how they are not a true facade implementation, and let me tell you, they're not 🤷. They're more like <a href=\"https://refactoring.guru/design-patterns/proxy/php/example#example-1\">proxies</a> than facades. If you think about it, they simply forward calls to their respective classes, effectively intercepting the request. When you start looking at them this way, you realize that facades, when used correctly, can result in a clean and testable code. So, don't get too caught up in the naming, I mean who cares what they are called? And let's see how we can make use of them.</p>\n<h2 id=\"same-same-but-different-but-still-same-\" style=\"position:relative;\"><a href=\"#same-same-but-different-but-still-same-\" aria-label=\"same same but different but still same  permalink\" class=\"anchor before\"><svg fill=\"#A855F7\" height=\"25px\" width=\"25px\" version=\"1.1\" id=\"Capa_1\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" \n              viewBox=\"0 0 490 490\" xml:space=\"preserve\">\n           <path d=\"M64.333,490h58.401l33.878-137.69h122.259L245.39,490h58.401l33.878-137.69h119.92v-48.162h-108.24l29.2-117.324h79.04\n             v-48.162H390.23L424.108,0H365.31l-33.878,138.661H208.79L242.668,0h-58.415l-33.864,138.661H32.411v48.162h106.298l-28.818,117.324\n             h-77.48v48.162h65.8L64.333,490z M197.11,186.824h122.642l-29.2,117.324H168.292L197.11,186.824z\"/>\n           </svg></a>Same-Same, But Different... But Still Same 😎</h2>\n<p>When writing service classes, I'm not a fan of using static methods, they make testing dependent classes <strong>HARD</strong>. However, I do love the clean calls of they offer, like <code class=\"language-text\">Service::action()</code>. With Laravel <a href=\"https://blog.oussama-mater.tech/laravel-core-facades/#laravel-real-time-facades\">real-time facades</a>, we can achieve this.</p>\n<p>Let's take a look at this example</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n\n<span class=\"token keyword\">namespace</span> <span class=\"token package\">App<span class=\"token punctuation\">\\</span>Services</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">use</span> <span class=\"token package\">Illuminate<span class=\"token punctuation\">\\</span>Support<span class=\"token punctuation\">\\</span>Facades<span class=\"token punctuation\">\\</span>Http</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token package\">App<span class=\"token punctuation\">\\</span>Exceptions<span class=\"token punctuation\">\\</span>CouldNotFetchRates</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token package\">App<span class=\"token punctuation\">\\</span>Entities<span class=\"token punctuation\">\\</span>ExchangeRate</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">ECBExchangeRateService</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">getRatesFromApi</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token class-name return-type\">ExchangeRate</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token variable\">$response</span> <span class=\"token operator\">=</span> <span class=\"token class-name static-context\">Http</span><span class=\"token operator\">::</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'ecb_url'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Avoid hardcoding URLs, this is just an example</span>\n\n        <span class=\"token function\">throw_if</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$response</span><span class=\"token operator\">-></span><span class=\"token function\">failed</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token class-name static-context\">CouldNotFetchRates</span><span class=\"token operator\">::</span><span class=\"token function\">apiTimeout</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'ecb'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">return</span> <span class=\"token class-name static-context\">ExchangeRate</span><span class=\"token operator\">::</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$response</span><span class=\"token operator\">-></span><span class=\"token function\">body</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></span></code></pre></div>\n<p>We have a hyper-simplified service class that attempts to retrieve exchange rates from an API and returns a DTO (Entity, or whatever makes you happy) if everything goes well.</p>\n<p>Now we can use this service like so</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n\n<span class=\"token keyword\">namespace</span> <span class=\"token package\">App<span class=\"token punctuation\">\\</span>Classes</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">use</span> <span class=\"token package\">App<span class=\"token punctuation\">\\</span>Services<span class=\"token punctuation\">\\</span>ECBExchangeRateService</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">AnotherClass</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">action</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword return-type\">void</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token variable\">$rates</span> <span class=\"token operator\">=</span> <span class=\"token class-name static-context\">ECBExchangeRateService</span><span class=\"token operator\">::</span><span class=\"token function\">getRatesFromApi</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        \n        <span class=\"token comment\">// Do something with the rates</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></span></code></pre></div>\n<p>The code might look clean, but it's not good; it's not testable. We can write feature tests or integration tests, but when it comes to unit testing this class, we can't. There's no way to mock <code class=\"language-text\">ECBExchangeRateService::getRatesFromApi()</code>, and unit tests <strong>should not</strong> have any dependencies (interactions with different classes or systems).</p>\n<blockquote>\n<p>Since we are discussing unit tests, I want to emphasize that <strong>should not</strong> doesn't mean you don't have to. Sometimes it makes sense to have database interaction in unit tests, for example, to test whether or not a relationship is loaded 🤷. Don't follow the rules blindly; sometimes they make sense, sometimes they don't.</p>\n</blockquote>\n<p>So, to fix this, we need to follow some steps:</p>\n<ol>\n<li>Convert the static <code class=\"language-text\">getRatesFromApi()</code> into a regular one;</li>\n<li>Create a new interface that defines which methods should be implemented by <code class=\"language-text\">ECBExchangeRateService</code> (optional);</li>\n<li>Bind the newly defined interface to our service class in the Laravel service provider (optional);</li>\n<li>Make use of dependency injection, whether via a constructor or directly into the method, depending on how you want your API to look.</li>\n</ol>\n<p>One might argue that this is the correct way to do things, but I'm a very simple guy. I feel that this is an overkill, especially if I know that I won't be changing any implementations for a very long time.</p>\n<blockquote>\n<p>I mean, I literally added the autolink to headers today, so I can link only the real-time section of my article. That's how much I want to keep things simple 😂</p>\n</blockquote>\n<p>With <a href=\"https://blog.oussama-mater.tech/laravel-core-facades/#laravel-real-time-facades\">real-time facades</a>, we can turn the 4 steps into 2:</p>\n<ol>\n<li>Convert the static <code class=\"language-text\">getRatesFromApi()</code> into a regular one (just remove the <code class=\"language-text\">static</code> keyword);</li>\n<li>Prefix the import with the <code class=\"language-text\">Facades</code> keyword.</li>\n</ol>\n<p>Your code should look like</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n\n<span class=\"token keyword\">namespace</span> <span class=\"token package\">App<span class=\"token punctuation\">\\</span>Classes</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">use</span> <span class=\"token package\">Facades<span class=\"token punctuation\">\\</span>App<span class=\"token punctuation\">\\</span>Services<span class=\"token punctuation\">\\</span>ECBExchangeRateService</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// The only change we need</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">AnotherClass</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">action</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword return-type\">void</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token variable\">$rates</span> <span class=\"token operator\">=</span> <span class=\"token class-name static-context\">ECBExchangeRateService</span><span class=\"token operator\">::</span><span class=\"token function\">getRatesFromApi</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        \n        <span class=\"token comment\">// do something with the rates</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></span></code></pre></div>\n<p>That's all we needed to do! Removed 1 keyword, and added another. You can't beat this!</p>\n<p>Here is how we can test our code now</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token function\">it</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'does something with the rates'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> \n    <span class=\"token class-name static-context\">ECBExchangeRateService</span><span class=\"token operator\">::</span><span class=\"token function\">shouldReceive</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'getRatesFromApi'</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">once</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n \n    <span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">AnotherClass</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">action</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<blockquote>\n<p>I am using <a href=\"https://pestphp.com/\">Pest</a>.</p>\n</blockquote>\n<p>The <code class=\"language-text\">ECBExchangeRateService</code> will be resolved from the container, just as we would do in the 4 steps above, without the need to create extra interfaces or add more code. We maintain our clean, simple approach and ensure testability. And I know some people still won't agree, dismissing it as <em>dark magic</em>. Well, it's not really magic if it is in the <a href=\"https://laravel.com/docs/11.x/facades#real-time-facades\">docs</a>; read your docs kids!</p>\n<h2 id=\"hooot-swappable-\" style=\"position:relative;\"><a href=\"#hooot-swappable-\" aria-label=\"hooot swappable  permalink\" class=\"anchor before\"><svg fill=\"#A855F7\" height=\"25px\" width=\"25px\" version=\"1.1\" id=\"Capa_1\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" \n              viewBox=\"0 0 490 490\" xml:space=\"preserve\">\n           <path d=\"M64.333,490h58.401l33.878-137.69h122.259L245.39,490h58.401l33.878-137.69h119.92v-48.162h-108.24l29.2-117.324h79.04\n             v-48.162H390.23L424.108,0H365.31l-33.878,138.661H208.79L242.668,0h-58.415l-33.864,138.661H32.411v48.162h106.298l-28.818,117.324\n             h-77.48v48.162h65.8L64.333,490z M197.11,186.824h122.642l-29.2,117.324H168.292L197.11,186.824z\"/>\n           </svg></a>Hooot Swappable 🔥</h2>\n<p>Remember what I mentioned about thinking of facades as proxies? Let's explain it.</p>\n<p>When using Laravel Queues, we dispatch jobs in our code. When you're testing that code, you're not interested in testing if the actual job is working as expected or not; that can be tested separately. Instead, you're interested in whether or not the job has been dispatched, the number of times it's been dispatched, the payload used, etc. So, to achieve this, we would need two implementations, right? <code class=\"language-text\">Dispatcher</code> and <code class=\"language-text\">DispatcherFake</code> - one that actually dispatches the job to Redis, MySQL, or whatever you've set it for, and the second one that does not dispatch anything, but rather captures those events.</p>\n<p>If we were to implement this ourselves, we would need to follow the 4 steps from earlier, and change the bindings of these implementations depending on the context - if we are running tests or if we are running the actual code. Now, Facades make this much simpler, like really simple. Let's see how.</p>\n<p>Let's first define our interface</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n\n<span class=\"token keyword\">namespace</span> <span class=\"token package\">App<span class=\"token punctuation\">\\</span>Contracts</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">interface</span> <span class=\"token class-name-definition class-name\">Dispatcher</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">dispatch</span><span class=\"token punctuation\">(</span><span class=\"token keyword type-hint\">mixed</span> <span class=\"token variable\">$job</span><span class=\"token punctuation\">,</span> <span class=\"token keyword type-hint\">mixed</span> <span class=\"token variable\">$handler</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword return-type\">mixed</span>\n<span class=\"token punctuation\">}</span></span></code></pre></div>\n<p>Then we can have two implementations</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n\n<span class=\"token keyword\">namespace</span> <span class=\"token package\">App<span class=\"token punctuation\">\\</span>Bus</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">use</span> <span class=\"token package\">PHPUnit<span class=\"token punctuation\">\\</span>Framework<span class=\"token punctuation\">\\</span>Assert</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token package\">App<span class=\"token punctuation\">\\</span>Contracts<span class=\"token punctuation\">\\</span>Dispatcher</span> <span class=\"token keyword\">as</span> DispatcherContract<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">Dispatcher</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">DispatcherContract</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">dispatch</span><span class=\"token punctuation\">(</span><span class=\"token keyword type-hint\">mixed</span> <span class=\"token variable\">$job</span><span class=\"token punctuation\">,</span> <span class=\"token keyword type-hint\">mixed</span> <span class=\"token variable\">$handler</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword return-type\">mixed</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// Actually dispatch this to the DB or whatever driver is set</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">DispatcherFake</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">DispatcherContract</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">protected</span> <span class=\"token variable\">$jobs</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">dispatch</span><span class=\"token punctuation\">(</span><span class=\"token keyword type-hint\">mixed</span> <span class=\"token variable\">$job</span><span class=\"token punctuation\">,</span> <span class=\"token keyword type-hint\">mixed</span> <span class=\"token variable\">$handler</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword return-type\">mixed</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// We are just recording the dispatches here</span>\n        <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">jobs</span><span class=\"token punctuation\">[</span><span class=\"token variable\">$job</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$handler</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// We can add testing helpers</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">assertDispatched</span><span class=\"token punctuation\">(</span><span class=\"token keyword type-hint\">mixed</span> <span class=\"token variable\">$job</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name static-context\">Assert</span><span class=\"token operator\">::</span><span class=\"token function\">assertTrue</span><span class=\"token punctuation\">(</span><span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">jobs</span><span class=\"token punctuation\">[</span><span class=\"token variable\">$job</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">assertDispatchedTimes</span><span class=\"token punctuation\">(</span><span class=\"token keyword type-hint\">mixed</span> <span class=\"token variable\">$job</span><span class=\"token punctuation\">,</span> <span class=\"token keyword type-hint\">int</span> <span class=\"token variable\">$times</span> <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name static-context\">Assert</span><span class=\"token operator\">::</span><span class=\"token function\">assertTrue</span><span class=\"token punctuation\">(</span><span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">jobs</span><span class=\"token punctuation\">[</span><span class=\"token variable\">$job</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">===</span> <span class=\"token variable\">$times</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// ... and more methods</span>\n<span class=\"token punctuation\">}</span></span></code></pre></div>\n<p>Now, instead of resolving implementations manually and having to bind multiple ones, we can make use of facades. They <strong>intercept</strong> the call, and we can choose where we want to forward it!</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n\n<span class=\"token keyword\">namespace</span> <span class=\"token package\">App<span class=\"token punctuation\">\\</span>Facades</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">use</span> <span class=\"token package\">App<span class=\"token punctuation\">\\</span>Bus<span class=\"token punctuation\">\\</span>DispatcherFake</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token package\">Illuminate<span class=\"token punctuation\">\\</span>Support<span class=\"token punctuation\">\\</span>Facades<span class=\"token punctuation\">\\</span>Facade</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">Dispatcher</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Facade</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">protected</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">fake</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token function\">tap</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">DispatcherFake</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$fake</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">// This will set the $resolvedInstance to the faked one</span>\n            <span class=\"token comment\">// So every time we try to access the underlying</span>\n            <span class=\"token comment\">// implementation, the faked object will be returned instead</span>\n            <span class=\"token keyword static-context\">static</span><span class=\"token operator\">::</span><span class=\"token function\">swap</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$fake</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">protected</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">getFacadeAccessor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token string single-quoted-string\">'dispatcher'</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></span></code></pre></div>\n<blockquote>\n<p>Interested in learning how Facades work under the hood? I've written an <a href=\"https://blog.oussama-mater.tech/laravel-core-facades/\">article</a> about it.</p>\n</blockquote>\n<p>Now we can simply bind our dispatcher to the application container.</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n\n<span class=\"token keyword\">namespace</span> <span class=\"token package\">App<span class=\"token punctuation\">\\</span>Providers</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">use</span> <span class=\"token package\">App<span class=\"token punctuation\">\\</span>Bus<span class=\"token punctuation\">\\</span>Dispatcher</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token package\">Illuminate<span class=\"token punctuation\">\\</span>Support<span class=\"token punctuation\">\\</span>ServiceProvider</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">AppServiceProvider</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">ServiceProvider</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">register</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword return-type\">void</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">app</span><span class=\"token operator\">-></span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'dispatcher'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$app</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Dispatcher</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    \n    <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span></span></code></pre></div>\n<p>And that's it! We can now elegantly swap between implementations, and our code is testable with clean calls, and no injections (but with the same effect).</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\">\n<span class=\"token keyword\">use</span> <span class=\"token package\">App<span class=\"token punctuation\">\\</span>Facades<span class=\"token punctuation\">\\</span>Dispatcher</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// import the facade</span>\n\n<span class=\"token function\">it</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'does dispatches a job'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// This will set the fake implementation as the resolved object</span>\n    <span class=\"token class-name static-context\">Dispatcher</span><span class=\"token operator\">::</span><span class=\"token function\">fake</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    \n    <span class=\"token comment\">// An action that dispatches a job `Dispatcher::dispatch(Job::class, Handler::class);</span>\n    <span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Action</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">handle</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Now you can assert that it has been dispatched</span>\n    <span class=\"token class-name static-context\">Dispatcher</span><span class=\"token operator\">::</span><span class=\"token function\">assertDispatched</span><span class=\"token punctuation\">(</span><span class=\"token class-name static-context\">Job</span><span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>This is a hyper-simplified example, just to see things from a new perspective. Interestingly, this is how your favorite framework tests things internally. So, facades might not be as much of an anti-pattern as you might think. They might be named incorrectly, but you can see how they simplify things.</p>\n<h3 id=\"eyes-open-\" style=\"position:relative;\"><a href=\"#eyes-open-\" aria-label=\"eyes open  permalink\" class=\"anchor before\"><svg fill=\"#A855F7\" height=\"25px\" width=\"25px\" version=\"1.1\" id=\"Capa_1\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" \n              viewBox=\"0 0 490 490\" xml:space=\"preserve\">\n           <path d=\"M64.333,490h58.401l33.878-137.69h122.259L245.39,490h58.401l33.878-137.69h119.92v-48.162h-108.24l29.2-117.324h79.04\n             v-48.162H390.23L424.108,0H365.31l-33.878,138.661H208.79L242.668,0h-58.415l-33.864,138.661H32.411v48.162h106.298l-28.818,117.324\n             h-77.48v48.162h65.8L64.333,490z M197.11,186.824h122.642l-29.2,117.324H168.292L197.11,186.824z\"/>\n           </svg></a>Eye's open 🔍</h3>\n<p>My colleague <a href=\"https://twitter.com/hjanos95\">János</a> made a good point worth considering, which might save a few hours of debugging 🧠.</p>\n<p>First, let's have a look at the <code class=\"language-text\">swap</code> method</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token comment\">/**\n* Hotswap the underlying instance behind the facade.\n*\n* @param  mixed  $instance\n* @return void\n*/</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">swap</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$instance</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword static-context\">static</span><span class=\"token operator\">::</span><span class=\"token variable\">$resolvedInstance</span><span class=\"token punctuation\">[</span><span class=\"token keyword static-context\">static</span><span class=\"token operator\">::</span><span class=\"token function\">getFacadeAccessor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$instance</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token keyword static-context\">static</span><span class=\"token operator\">::</span><span class=\"token variable\">$app</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword static-context\">static</span><span class=\"token operator\">::</span><span class=\"token variable\">$app</span><span class=\"token operator\">-></span><span class=\"token function\">instance</span><span class=\"token punctuation\">(</span><span class=\"token keyword static-context\">static</span><span class=\"token operator\">::</span><span class=\"token function\">getFacadeAccessor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$instance</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Binding the faked instance to the container</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>You can see that when swapping instances, we're not just replacing the cached resolved instance; we're also binding it to the container. This implies that <strong>ALL</strong> future returned instances, whether using dependency injection or the <code class=\"language-text\">app()</code> helper, will yield a fake implementation. So, if you're running integration tests, where some classes use constructor injection and not facades, they will also receive the faked implementation. Nevertheless, if you ever call the <code class=\"language-text\">fake()</code> method, you would expect to receive the fake implementation everywhere anyway. However, it's something to bear in mind when writing tests (especially integration tests), where you might want to use the <strong>actual</strong> class instead.</p>\n<h2 id=\"conclusion\" style=\"position:relative;\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"anchor before\"><svg fill=\"#A855F7\" height=\"25px\" width=\"25px\" version=\"1.1\" id=\"Capa_1\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" \n              viewBox=\"0 0 490 490\" xml:space=\"preserve\">\n           <path d=\"M64.333,490h58.401l33.878-137.69h122.259L245.39,490h58.401l33.878-137.69h119.92v-48.162h-108.24l29.2-117.324h79.04\n             v-48.162H390.23L424.108,0H365.31l-33.878,138.661H208.79L242.668,0h-58.415l-33.864,138.661H32.411v48.162h106.298l-28.818,117.324\n             h-77.48v48.162h65.8L64.333,490z M197.11,186.824h122.642l-29.2,117.324H168.292L197.11,186.824z\"/>\n           </svg></a>Conclusion</h2>\n<p>Don't fight the framework; embrace it and try to make use of what already exists. There are multiple approaches to each problem, and they can all be good. Don't dismiss something just because someone else thinks otherwise; give it a chance. To me, as long as the code is testable, you're on the right path, you shouldn't worry too much about whether or not it follows certain rules.</p>\n<blockquote>\n<p>If you have any thoughts we can include in the article, feel free to ping me!</p>\n</blockquote>","frontmatter":{"title":"Laravel Facades - Write Testable Code","date":"April 10, 2024","description":"Laravel relies heavily on Facades. Some might think they are anti-patterns, but I believe that if they are used correctly, they can result in clean and testable code. Let's see how."}},"previous":{"fields":{"slug":"/laravel-zero-tcp-server/"},"frontmatter":{"title":"Laravel Zero - Let's build a TCP server"}},"next":{"fields":{"slug":"/laravel-internals-strategy-pattern/"},"frontmatter":{"title":"Laravel Internals - The Strategy Pattern"}}},"pageContext":{"id":"956642b6-a0f2-5634-9742-a6d32b383180","previousPostId":"1d172da4-a494-51dc-9440-c213f4d7742e","nextPostId":"3e660b78-2b49-5557-bf68-66289beea904"}},"staticQueryHashes":["2841359383","494442451"],"slicesMap":{}}
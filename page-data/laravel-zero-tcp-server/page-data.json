{"componentChunkName":"component---src-templates-blog-post-js","path":"/laravel-zero-tcp-server/","result":{"data":{"site":{"siteMetadata":{"title":"Personal Blog"}},"markdownRemark":{"id":"1d172da4-a494-51dc-9440-c213f4d7742e","excerpt":"Hello ðŸ‘‹  A few weeks ago, I began working on a TCP server for an upcoming annual CTF hosted by my team \"Securinets ISI\". The goal is to enable players toâ€¦","html":"<h2>Hello ðŸ‘‹</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/5fc1459f3b756f4fe3f94cbd63269f6e/0f882/cover.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 25.316455696202528%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAA7EAAAOxAGVKw4bAAABWklEQVR42h3O0W7SUACA4d7pRlhboGc9beFQdiillDYM0DnAWJnBmGVkW9ySugUvjJt6o9mFWbLd7N7H8Dl/E78n+Ixs/Ui6/E52dEOYf0JlG/R4gxt9RKVn2K7GdHJk+BrLiXlecajabUSrwNMFQmZUrIAt2+OZWcfIz36j0lOC7jGt5Jxw/AU92eANrvD1e8xahC2GSDWnIYds7+xiCY0Ml7hqgS0ztuwmlXqHakNjxPNjfD3Hax/idRb4vTcMX52QzC7Jpx+I0xmhHhMlC6J0Ri/ZJ+5P6WcFws8Q7gDLUdR22+yYAcb49CfhqKQ1uKI1+kx3dUf09pa4fCLonuD4E4Q6+j8S7j6i2Sc+KBFqhey8w1MHBH7Ethmw+nqHMTl/YG96Qzj6QfvlL4blH5L1Iy/u/yJ7JTVV0OhcIPfWNMIllsppHn5D6mv87pp6ck01LhBeTu/2iX8+CJqU/UqZIgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"cover\"\n        title=\"cover\"\n        src=\"/static/5fc1459f3b756f4fe3f94cbd63269f6e/f058b/cover.png\"\n        srcset=\"/static/5fc1459f3b756f4fe3f94cbd63269f6e/c26ae/cover.png 158w,\n/static/5fc1459f3b756f4fe3f94cbd63269f6e/6bdcf/cover.png 315w,\n/static/5fc1459f3b756f4fe3f94cbd63269f6e/f058b/cover.png 630w,\n/static/5fc1459f3b756f4fe3f94cbd63269f6e/40601/cover.png 945w,\n/static/5fc1459f3b756f4fe3f94cbd63269f6e/78612/cover.png 1260w,\n/static/5fc1459f3b756f4fe3f94cbd63269f6e/0f882/cover.png 1584w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>A few weeks ago, I began working on a TCP server for an upcoming annual CTF hosted by my team \"Securinets ISI\". The goal is to enable players to quickly submit flags using a command like:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"flag\"</span> <span class=\"token operator\">|</span> <span class=\"token function\">nc</span> <span class=\"token number\">127.0</span>.0.1 <span class=\"token number\">8000</span></code></pre></div>\n<p>For this task, I needed to develop a console application. Instead of pulling packages independently, like the DB and Views component from Laravel, the console component from Symfony, and Phinx for DB migrations, I found Laravel Zero to be the perfect fit. We'll be using it to build the server!</p>\n<blockquote>\n<p>Laravel Zero is a lightweight and modular micro-framework for developing fast and powerful console applications. Built on top of the Laravel components.</p>\n</blockquote>\n<h2>A little about servers</h2>\n<p>If you're not familiar with what a TCP server is, no worries, you've been using one your whole life. Web servers are TCP servers, just with a layer of abstraction. This one operates on a slightly lower level. A server will listen on a \"server socket\", and a <a href=\"https://www.keil.com/pack/doc/mw6/Network/html/using_network_sockets_tcp.html\">socket</a> is nothing but an IP bound to a PORT, represented as IP:PORT. This socket waits for clients to make requests. Therefore, every communication involves two sockets; one for the server and one for the client.</p>\n<p>The client receives a random port assigned by the OS on-the-fly when connecting to the server. Yes, a single server socket can handle multiple clients, though not concurrently. Each time a client connects, it is pushed to an <a href=\"https://www.alibabacloud.com/blog/tcp-syn-queue-and-accept-queue-overflow-explained_599203\">accept queue</a>, waiting for its turn.</p>\n<blockquote>\n<p>Knowing how servers work is genuinely interesting. I've provided a few links for you to read; have fun exploring. And yes, I'll be writing about those soon.</p>\n</blockquote>\n<h2>Building the server</h2>\n<p>Without further ado, let's begin by installing Laravel Zero:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">composer</span> create-project --prefer-dist laravel-zero/laravel-zero securinets</code></pre></div>\n<p>Now, you can rename the application to whatever makes sense to you:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">php application app:rename securinets</code></pre></div>\n<p>Next, I want to be able to use environment variables. My application will need the database, and I'll also require the Blade engine. Laravel Zero makes it easy to install those components:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">php securinets app:install dotenv\nphp securinets app:install database\nphp securinets app:install view</code></pre></div>\n<p>We can start using our console app by running:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">php securinets <span class=\"token punctuation\">[</span>command<span class=\"token punctuation\">]</span></code></pre></div>\n<p>For our case, we need to build a TCP server, actively listening for incoming connections. We have a few options for that, like RoadRunner or Swoole, and I am choosing the latter.</p>\n<p><a href=\"https://openswoole.com/docs\">Swoole</a> is a PHP extension that enables you to do A LOT of things, such as asynchronous programming, event loops, coroutines, and much more.</p>\n<p>For Linux, the installation is straightforward:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> update <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> <span class=\"token function\">install</span> <span class=\"token parameter variable\">-y</span> php8.2-openswoole</code></pre></div>\n<blockquote>\n<p>I am using PHP 8.2, adjust the version accordingly.</p>\n</blockquote>\n<p>For VSCode users, you can assist the IDE by installing the following package:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">composer</span> require openswoole/ide-helper</code></pre></div>\n<p>Then, in your <code class=\"language-text\">settings.json</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token property\">\"intelephense.environment.includePaths\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token string\">\"vendor/openswoole/ide-helper\"</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></code></pre></div>\n<p>Now, we can use Laravel Zero to generate a new command to start the server:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">php securinets make:command ServeCommand</code></pre></div>\n<p>In the <code class=\"language-text\">ServeCommand</code>, we can make use of Swoole. It provides a <code class=\"language-text\">Server</code> class that expects a host and a port. The good news is you can still define environment variables and reference them in the config, just like you would in your Laravel application. All of this is handled by Laravel Zero because, as you may recall, we installed those components using the <code class=\"language-text\">app:install</code> command, which you would otherwise have to do manually.</p>\n<p>I appreciate how organized the Laravel <code class=\"language-text\">serve</code> command logs are, so maybe we create something similar? I know for a fact that Laravel constructs the logs by combining <code class=\"language-text\">echo</code> statements with <code class=\"language-text\">str_repeat</code>, everything is done in the command itself. However, I find this approach a bit noisy. So, let's leverage the Blade engine for a cleaner solution.</p>\n<p>In your <code class=\"language-text\">resources/views</code>, create a <code class=\"language-text\">log.blade.php</code> view</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>flex<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>span</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>mr-1 ml-2 text-gray-600<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>{{ $date }}<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>span</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>span</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>mr-1<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>{{ $hour }}<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>span</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>span</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>mr-1 font-bold<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>[{{ $client }}]<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>span</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>span</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>mr-2 text-gray-600<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n        {{ str_repeat('.', max(\\Termwind\\terminal()->width() - 80 - mb_strlen($client), 0)) }}\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>span</span><span class=\"token punctuation\">></span></span>\n    &lt;span @class([\n        'px-1 font-bold',\n        'text-red' => !$connected,\n        'text-green' => $connected,\n    ])\">{{ $connected ? 'CONNECTED' : 'DISCONNECTED' }}<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>span</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>This is what we will see in our logs. Now, for the responses we will be sending to the clients, we want them to be cool as well. So, create a <code class=\"language-text\">response.blade.php</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>py-1 ml-2<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n    &lt;div @class([\n        'px-1 text-white',\n        'bg-red' => !$correct,\n        'bg-green-600' => $correct,\n    ])>\n        {{ $correct ? 'SUCCESS' : 'ERROR' }}\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>span</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>ml-1<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n        {{ $message }}\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>span</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>Now that our views are ready, you might be wondering, \"Isn't this Tailwind CSS?\" Well, yes, it is! Laravel Zero ships with <a href=\"https://github.com/nunomaduro/termwind\">Termwind</a>, another great package that enables you to use Tailwind CSS classes for console applications.</p>\n<p>Now, we can use Swoole. But before that, let's go over the basics. To create a server, you need to instantiate the <code class=\"language-text\">OpenSwoole\\Server</code> class. By doing that, you can hook into various events. We will be using <code class=\"language-text\">Start</code>, <code class=\"language-text\">Connect</code>, <code class=\"language-text\">Receive</code>, and <code class=\"language-text\">Close</code>. You can find all the events <a href=\"https://openswoole.com/docs/modules/swoole-server-doc#events\">here</a>.</p>\n<blockquote>\n<p>Under the hood, Swoole runs an event loop. Event loops are what made Nginx revolutionary and are the solution to the C10k problem. Curious? We will be traveling back to 2004 soon to discuss those ðŸ‘€</p>\n</blockquote>\n<p>Now, with what we learned, the command will look like (code is commented)</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n\n<span class=\"token keyword\">namespace</span> <span class=\"token package\">App<span class=\"token punctuation\">\\</span>Commands</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">use</span> <span class=\"token package\">OpenSwoole<span class=\"token punctuation\">\\</span>Server</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token package\">Termwind<span class=\"token punctuation\">\\</span>HtmlRenderer</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token package\">LaravelZero<span class=\"token punctuation\">\\</span>Framework<span class=\"token punctuation\">\\</span>Commands<span class=\"token punctuation\">\\</span>Command</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">use</span> <span class=\"token keyword\">function</span> <span class=\"token package\">Termwind<span class=\"token punctuation\">\\</span>render</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">ServeCommand</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Command</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword type-declaration\">string</span> <span class=\"token variable\">$host</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword type-declaration\">int</span> <span class=\"token variable\">$port</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">__construct</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword static-context\">parent</span><span class=\"token operator\">::</span><span class=\"token function\">__construct</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">host</span> <span class=\"token operator\">=</span> <span class=\"token function\">config</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'server.host'</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'127.0.0.1'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">port</span> <span class=\"token operator\">=</span> <span class=\"token function\">config</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'server.port'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">9001</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">/**\n     * The signature of the command.\n     *\n     * @var string\n     */</span>\n    <span class=\"token keyword\">protected</span> <span class=\"token variable\">$signature</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'serve'</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">/**\n     * The description of the command.\n     *\n     * @var string\n     */</span>\n    <span class=\"token keyword\">protected</span> <span class=\"token variable\">$description</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'Start the flag submission server.'</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">handle</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword return-type\">mixed</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// Create a server object</span>\n        <span class=\"token variable\">$server</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Server</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">host</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">port</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// Hook into the Start event</span>\n        <span class=\"token variable\">$server</span><span class=\"token operator\">-></span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'Start'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">/** @var \\Illuminate\\Contracts\\Support\\Renderable $render */</span>\n            <span class=\"token variable\">$render</span> <span class=\"token operator\">=</span> <span class=\"token function\">view</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'start'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>\n                <span class=\"token string single-quoted-string\">'host'</span> <span class=\"token operator\">=></span> <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">host</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string single-quoted-string\">'port'</span> <span class=\"token operator\">=></span> <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">port</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token comment\">// Yes, you can use the Blade engine to return the HTML as a rendered string,</span>\n            <span class=\"token comment\">// which can then be rendered by Termwind</span>\n            <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$render</span><span class=\"token operator\">-></span><span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token variable\">$server</span><span class=\"token operator\">-></span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'Connect'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token class-name type-declaration\">Server</span> <span class=\"token variable\">$server</span><span class=\"token punctuation\">,</span> <span class=\"token keyword type-hint\">int</span> <span class=\"token variable\">$fd</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$server</span><span class=\"token operator\">-></span><span class=\"token function\">getClientInfo</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$fd</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token constant boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token variable\">$server</span><span class=\"token operator\">-></span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'Receive'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token class-name type-declaration\">Server</span> <span class=\"token variable\">$server</span><span class=\"token punctuation\">,</span> <span class=\"token keyword type-hint\">int</span> <span class=\"token variable\">$fd</span><span class=\"token punctuation\">,</span> <span class=\"token keyword type-hint\">int</span> <span class=\"token variable\">$reactor_id</span><span class=\"token punctuation\">,</span> <span class=\"token keyword type-hint\">string</span> <span class=\"token variable\">$data</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">// I am only simulating the response; you should execute the business logic.</span>\n            <span class=\"token variable\">$response</span> <span class=\"token operator\">=</span> <span class=\"token function\">view</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'response'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>\n                <span class=\"token string single-quoted-string\">'message'</span> <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'Correct submission, keep it up.'</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string single-quoted-string\">'correct'</span> <span class=\"token operator\">=></span> <span class=\"token constant boolean\">true</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token variable\">$response</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">HtmlRenderer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$data</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token comment\">// This is important; if you want the client to see a correctly rendered output,</span>\n            <span class=\"token comment\">// you need to format it, so the result is an escaped ANSI sequence</span>\n            <span class=\"token variable\">$response</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">output</span><span class=\"token operator\">-></span><span class=\"token function\">getFormatter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">format</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$response</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token variable\">$server</span><span class=\"token operator\">-></span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$fd</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$response</span> <span class=\"token operator\">.</span> <span class=\"token constant\">PHP_EOL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token variable\">$server</span><span class=\"token operator\">-></span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$fd</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token variable\">$server</span><span class=\"token operator\">-></span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'Close'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token class-name type-declaration\">Server</span> <span class=\"token variable\">$server</span><span class=\"token punctuation\">,</span> <span class=\"token keyword type-hint\">int</span> <span class=\"token variable\">$fd</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$server</span><span class=\"token operator\">-></span><span class=\"token function\">getClientInfo</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$fd</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token constant boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// This will start the TCP server</span>\n        <span class=\"token variable\">$server</span><span class=\"token operator\">-></span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">return</span> <span class=\"token class-name static-context\">Command</span><span class=\"token operator\">::</span><span class=\"token constant\">SUCCESS</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">/**\n     * @param array&lt;string>|bool $infos\n     */</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">log</span><span class=\"token punctuation\">(</span><span class=\"token keyword type-declaration\">array</span><span class=\"token operator\">|</span><span class=\"token keyword type-declaration\">bool</span> <span class=\"token variable\">$infos</span><span class=\"token punctuation\">,</span> <span class=\"token keyword type-hint\">bool</span> <span class=\"token variable\">$connected</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword return-type\">void</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">is_array</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$infos</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">/** @var \\Illuminate\\Contracts\\Support\\Renderable $render */</span>\n            <span class=\"token variable\">$render</span> <span class=\"token operator\">=</span> <span class=\"token function\">view</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'log'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>\n                <span class=\"token string single-quoted-string\">'date'</span> <span class=\"token operator\">=></span> <span class=\"token function\">date</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'Y-m-d'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string single-quoted-string\">'hour'</span> <span class=\"token operator\">=></span> <span class=\"token function\">date</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'H:i:s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string single-quoted-string\">'client'</span> <span class=\"token operator\">=></span> <span class=\"token variable\">$infos</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'remote_ip'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string single-quoted-string\">'connected'</span> <span class=\"token operator\">=></span> <span class=\"token variable\">$connected</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$render</span><span class=\"token operator\">-></span><span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></span></code></pre></div>\n<blockquote>\n<p>You can find all the methods on the server object <a href=\"https://openswoole.com/docs/modules/swoole-http-server-doc#methods\">here</a>.</p>\n</blockquote>\n<p>One thing I want to bring to your attention is on the receive event. In this example, we are echoing back whatever the client sent. Feel free to implement the logic there; for instance, in my case, I would validate the submitted flag against certain criteria. Additionally, please note that to print the output as you would expect it, you need to get the formatter used by the console commands under the hood and send its result, which is an ANSI sequence. This way, it can be rendered correctly on the client's terminal.</p>\n<p>Now, we can run our server by executing the following command</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">php securinets serve</code></pre></div>\n<p>And you will be prompted with</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/9d0351f4052dee2e098fa8d01c1af8dc/c1c45/result.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 54.43037974683544%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAABn0lEQVR42n2S3XLTMBSE/TQwnQb/6i+yLUuKLDl23DJNp3DHLQzvwKsvIyUpJaRcfLOyNFrrnLNZ03pw+wg6LGj6GWLrIcQOpN2B9QGdfcB2WMC6CbVw+NQMyIl+1Wuy6eU7vv74BdIGEOlBu+nMHlt9gNSHZCjNCuUeUVD9X9Os0xOMX9GbAN469Dqg1x7tMEKZgIoZFNSgZDZxMXprel8pbOrTXlZSjZpr1MJC9BN4LNMc0NsVnVmS2cXg+kXxO95Tbg+pPKJXVlKDillU3KZ+xRLd/CVhwzH1LSdDKrUgbziXzqXDsl8xuRmM29MLK24S0sSeLdD+CTo8YRg/px9dG+ZnjYZUWHi7x04FMGaR5cQgp/YEeQ/zh8akveJ8FrVoDMqo1CJrqANtHDgfIToP0YUTMU6tRy1GEDmBdQtYO0OoFSVzKOhtso8PAR9+HnH3PIPLEbR1aTCs9aDSgcgRjRxRi9152n8P6Zrsfp6w+XbE3TyBiBGVcK+ZjAOJWnGXInNr0v/ksGoM6kIjLxQ2jUoXNrVKXNbvReaW4W/Ch3IUKYbyaQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"result\"\n        title=\"result\"\n        src=\"/static/9d0351f4052dee2e098fa8d01c1af8dc/f058b/result.png\"\n        srcset=\"/static/9d0351f4052dee2e098fa8d01c1af8dc/c26ae/result.png 158w,\n/static/9d0351f4052dee2e098fa8d01c1af8dc/6bdcf/result.png 315w,\n/static/9d0351f4052dee2e098fa8d01c1af8dc/f058b/result.png 630w,\n/static/9d0351f4052dee2e098fa8d01c1af8dc/c1c45/result.png 824w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<blockquote>\n<p>Am I the only one getting excited for this, I mean how cool is that?</p>\n</blockquote>\n<h2>What else?</h2>\n<p>Now that we have our console application, we want to ensure that this command is always running. For one reason or another, it can crash and stop. When that happens, we want to be able to restart it immediately. That's why I will be using <a href=\"http://supervisord.org/\">Supervisor</a> to do so.</p>\n<p>For Linux users, you can run the following commands:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> update <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> <span class=\"token function\">install</span> supervisor</code></pre></div>\n<p>Now, create a config file:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> <span class=\"token function\">nano</span> /etc/supervisor/conf.d/securinets.conf</code></pre></div>\n<p>Paste the following config:</p>\n<div class=\"gatsby-highlight\" data-language=\"ini\"><pre class=\"language-ini\"><code class=\"language-ini\"><span class=\"token section\"><span class=\"token punctuation\">[</span><span class=\"token section-name selector\">program:securinets</span><span class=\"token punctuation\">]</span></span>\n<span class=\"token key attr-name\">process_name</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">%(program_name)s_%(process_num)02d</span>\n<span class=\"token key attr-name\">command</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">/usr/bin/php8.2 /path/to/console/application/securinets serve</span>\n<span class=\"token key attr-name\">autostart</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">true</span>\n<span class=\"token key attr-name\">autorestart</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">true</span>\n<span class=\"token key attr-name\">stopasgroup</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">true</span>\n<span class=\"token key attr-name\">killasgroup</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">true</span>\n<span class=\"token key attr-name\">user</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">always-a-low-privileged-user</span>\n<span class=\"token key attr-name\">numprocs</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">1</span>\n<span class=\"token key attr-name\">redirect_stderr</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">true</span>\n<span class=\"token key attr-name\">stdout_logfile</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">/var/log/securinets.log</span>\n<span class=\"token key attr-name\">stopwaitsecs</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">3600</span></code></pre></div>\n<blockquote>\n<p>Read more about the configuration <a href=\"http://supervisord.org/configuration.html\">here</a>.</p>\n</blockquote>\n<p>Start Supervisor by running:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> supervisorctl reread\n<span class=\"token function\">sudo</span> supervisorctl update\n<span class=\"token function\">sudo</span> supervisorctl start securinets:*</code></pre></div>\n<p>Now, your TCP server will be running. If you want to run multiple instances, set <code class=\"language-text\">numprocs</code> to 5, for example. In your application, check if the port is taken and move to the next one. This way, you'll have 5 TCP servers with ports <code class=\"language-text\">8000</code> to <code class=\"language-text\">8004</code> if you started with port <code class=\"language-text\">8000</code>.</p>\n<p>That's it! For more fun, you can set up Nginx as a reverse proxy to add rate limits. Although we won't cover it in this article, <a href=\"https://docs.nginx.com/nginx/admin-guide/load-balancer/tcp-udp-load-balancer/\">docs</a> are your bestfriend.</p>\n<h2>Conclusion</h2>\n<p>Laravel Zero is a powerful package to kickstart console applications. We barely scratched the surface, as it offers much more. You can build interactive menus, schedule tasks, send desktop notifications, consume APIs using the built-in HTTP client, cache data, and even build the application as a standalone executable. So, the next time you're working on such apps, consider using Laravel Zero, it might be exactly what you're looking for! âœ¨</p>","frontmatter":{"title":"Laravel Zero - Let's build a TCP server","date":"February 25, 2024","description":"Building console applications can be a lot of fun, but also quite challenging. However, Laravel Zero makes it incredibly easy and way more enjoyable!"}},"previous":{"fields":{"slug":"/code-to-an-interface/"},"frontmatter":{"title":"Code to an interface!"}},"next":null},"pageContext":{"id":"1d172da4-a494-51dc-9440-c213f4d7742e","previousPostId":"97e03c69-950b-5a45-a39d-ac614715e1d8","nextPostId":null}},"staticQueryHashes":["2841359383","494442451"],"slicesMap":{}}